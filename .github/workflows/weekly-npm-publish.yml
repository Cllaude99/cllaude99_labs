name: Weekly NPM Publish

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ KST 19:30 (UTC 10:30)
    - cron: '30 10 * * 1'

  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡
  workflow_dispatch:

jobs:
  publish-npm:
    name: Publish UI Package to NPM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.0'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Bump version
        id: bump_version
        run: |
          cd packages/ui

          # í˜„ì¬ ë²„ì „ ê°€ì ¸ì˜¤ê¸°
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

          # ë²„ì „ ë¶„ë¦¬ (a.b.c)
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          A="${VERSION_PARTS[0]}"
          B="${VERSION_PARTS[1]}"
          C="${VERSION_PARTS[2]}"

          echo "A=$A, B=$B, C=$C"

          # C ì¦ê°€ (0-9 ë²”ìœ„)
          C=$((C + 1))

          # Cê°€ 10ì´ ë˜ë©´ B ì¦ê°€, CëŠ” 0ìœ¼ë¡œ ë¦¬ì…‹
          if [ $C -eq 10 ]; then
            C=0
            B=$((B + 1))
          fi

          # Bê°€ 10ì´ ë˜ë©´ A ì¦ê°€, BëŠ” 0ìœ¼ë¡œ ë¦¬ì…‹
          if [ $B -eq 10 ]; then
            B=0
            A=$((A + 1))
          fi

          # ìƒˆ ë²„ì „ ìƒì„±
          NEW_VERSION="$A.$B.$C"
          echo "ìƒˆ ë²„ì „: $NEW_VERSION"

          # package.json ì—…ë°ì´íŠ¸
          npm version $NEW_VERSION --no-git-tag-version

          # í™˜ê²½ë³€ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "OLD_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Build UI package
        run: pnpm --filter @cllaude99/ui build

      - name: Run tests and checks
        run: |
          pnpm --filter @cllaude99/ui lint
          pnpm --filter @cllaude99/ui type-check

      - name: Setup NPM authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Publish to NPM
        run: |
          cd packages/ui
          npm publish --access=public

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/ui/package.json
          git commit -m "chore(ui): bump version to ${{ steps.bump_version.outputs.NEW_VERSION }}

          ğŸ“¦ ìë™ ë²„ì „ ì—…ë°ì´íŠ¸ ë° NPM ë°°í¬

          - ì´ì „ ë²„ì „: ${{ steps.bump_version.outputs.OLD_VERSION }}
          - ìƒˆ ë²„ì „: ${{ steps.bump_version.outputs.NEW_VERSION }}
          - ë°°í¬ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S KST')

          ğŸ¤– Generated with GitHub Actions"
          git push

      - name: Create Git Tag
        run: |
          git tag "v${{ steps.bump_version.outputs.NEW_VERSION }}"
          git push origin "v${{ steps.bump_version.outputs.NEW_VERSION }}"

      - name: Deployment Summary
        run: |
          echo "âœ… NPM ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“¦ íŒ¨í‚¤ì§€: @cllaude99/ui"
          echo "ğŸ”– ì´ì „ ë²„ì „: ${{ steps.bump_version.outputs.OLD_VERSION }}"
          echo "ğŸ”– ìƒˆ ë²„ì „: ${{ steps.bump_version.outputs.NEW_VERSION }}"
          echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸŒ NPM: https://www.npmjs.com/package/@cllaude99/ui"
